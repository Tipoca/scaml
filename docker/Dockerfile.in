FROM ubuntu:18.04
MAINTAINER Jun FURUSE <jun.furuse@dailambda.jp>

RUN apt-get clean

# Replacing the source

RUN sed -e 's|/archive\.ubuntu\.com/ubuntu|/ftp.jaist.ac.jp/pub/Linux/ubuntu|g' /etc/apt/sources.list > /tmp/sources.list
RUN mv /tmp/sources.list /etc/apt/sources.list
RUN apt-get update

RUN apt-get install -y --no-install-recommends curl git ca-certificates make patch sudo netbase jq

# OCaml and OPAM

RUN apt install -y --no-install-recommends pkg-config libgmp-dev libev-dev libhidapi-dev m4 unzip bubblewrap ocaml g++
USER root
WORKDIR /
RUN git clone https://github.com/ocaml/opam
WORKDIR opam
RUN git checkout 2.0.3
RUN ./configure
RUN make lib-ext && make && make install
RUN opam init -a --bare --disable-sandboxing # bwrap does not work...

# required for install local opams
RUN apt install -y --no-install-recommends rsync

# SCaml
# 
WORKDIR /
RUN git clone https://gitlab.com/dailambda/scaml.git
WORKDIR /scaml
RUN opam switch create . ocaml-base-compiler.4.07.1
RUN opam update
RUN git pull
RUN git checkout @COMMIT@
RUN eval $(opam env) && env && opam install -y vendors/*/*.opam src/scaml.opam

# Cleanup
WORKDIR /
RUN du -sh /usr /scaml /root /var

RUN rm -rf /opam
RUN (cd /scaml; opam clean)
RUN opam clean
RUN rm -rf /scaml/_opam/.opam-switch
RUN rm -rf /root/.opam
RUN tar zcf /tmp/scaml.tgz /scaml/_opam/lib/stublibs /scaml/_opam/lib/ocaml/stdlib.cmi /scaml/_opam/bin/scamlc /scaml/_opam/lib/scaml
RUN rm -rf /scaml/_opam
RUN tar xvf /tmp/scaml.tgz
RUN rm -rf /usr/local

RUN apt remove -y ocaml g++ git gcc bubblewrap ca-certificates cpp-7
RUN apt-get clean
RUN apt remove -y '*-dev' > /dev/null 2>&1
RUN apt remove -y curl perl make
RUN apt autoremove -y
RUN rm -rf /var/lib/apt

RUN du -sh /usr /scaml /root /var

RUN SCAMLIB=/scaml/_opam/lib/scaml /scaml/_opam/bin/scamlc /scaml/src/tests/app_vote.ml && echo OK
